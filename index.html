<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Navegaci√≥n Fluvial</title>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px;}
header{position:relative;background:#1e3a5f;color:white;padding:15px;border-radius:6px;margin-bottom:15px;}
#adminBtn{position:absolute;top:12px;right:15px;background:transparent;border:none;font-size:18px;cursor:pointer;}
select,input,button{padding:6px;font-size:14px;}
.km{background:white;padding:8px;margin-bottom:6px;border-left:6px solid #ccc;border-radius:4px;cursor:pointer;}
.km:hover{background:#eef2f7;}
.selected{outline:2px solid #ff9800;}
.roja{border-left-color:#c62828;}
.verde{border-left-color:#2e7d32;}
.negra{border-left-color:#000;}
.azul{border-left-color:#1565c0;}
.violeta{border-left-color:#6a1b9a;}
.obs{font-size:13px;color:#333;margin-top:4px;}
.menu{margin-top:8px;padding-top:8px;border-top:1px dashed #ccc;}
.menu button{margin-right:6px;font-size:13px;}
.panel{background:white;padding:12px;border-radius:6px;margin-bottom:15px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;}
.modal-content{background:white;padding:15px;border-radius:6px;max-width:520px;width:90%;max-height:90%;overflow:auto;}
.close{float:right;font-weight:bold;cursor:pointer;}
textarea{width:100%;min-height:70px;}
.historico{font-size:13px;margin-bottom:8px;border-bottom:1px solid #ddd;padding-bottom:4px;}
.fecha{color:#555;font-size:12px;}
</style>
</head>

<body>

<header>
<button id="adminBtn" onclick="activarAdmin()">üîí</button>
<h2 id="tituloTramo"></h2>

Tramo:
<select id="selectorTramo" onchange="cambiarTramo()"></select>

Sentido:
<select id="sentido" onchange="cambiarSentido()">
<option value="up">Aguas arriba</option>
<option value="down">Aguas abajo</option>
</select>
</header>

<div class="panel">
<h3>üìè Estimativas</h3>
KM actual:
<input id="kmActual" type="number" step="0.1" oninput="recalcular()">
Velocidad:
<input id="velocidad" type="number" value="12" step="0.1" oninput="recalcular()">
Hora inicio:
<input id="horaInicio" type="time" oninput="recalcular()">
<div id="resultado"></div>
</div>

<div id="lista"></div>

<!-- MODAL OBS -->
<div class="modal" id="modalObs">
<div class="modal-content">
<span class="close" onclick="cerrar('modalObs')">√ó</span>
<h3>Observaciones ‚Äì KM <span id="kmObs"></span></h3>
<div id="historial"></div>
<textarea id="textoObs"></textarea>
<button onclick="guardarObs()">Guardar</button>
</div>
</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, query,
  orderBy, onSnapshot, deleteDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdffoO-Bmp0EY2Lu-HxNga0hTRHr3S9BA",
  authDomain: "navegacion-fluvial.firebaseapp.com",
  projectId: "navegacion-fluvial",
  storageBucket: "navegacion-fluvial.firebasestorage.app",
  messagingSenderId: "767971648775",
  appId: "1:767971648775:web:784d1ac3310653e7d891a2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= ADMIN ================= */
const CLAVE_ADMIN="parana123";
let esAdmin = localStorage.getItem("admin")==="true";

window.activarAdmin = function(){
  if(esAdmin){
    esAdmin=false;
    localStorage.removeItem("admin");
  }else{
    const pass=prompt("Clave administrador:");
    if(pass===CLAVE_ADMIN){
      esAdmin=true;
      localStorage.setItem("admin","true");
    }
  }
  adminBtn.textContent = esAdmin ? "üîì" : "üîí";
}

/* ================= TRAMOS ================= */
const TRAMOS={L6M:{nombre:"R√≠o Paran√° ‚Äì L6M",inicio:480,fin:568,destinos:[533,568],
data:[{km:480},{km:481.4},{km:484.5},{km:486},{km:488},{km:489.4},{km:491},{km:492},{km:494},{km:495.8},{km:497.5},{km:498},{km:499.7},{km:500},{km:500.5},{km:501.6},{km:502.4},{km:504.5},{km:506.7},{km:508},{km:509.2},{km:509.9},{km:513.7},{km:516.2},{km:517.9},{km:518.4},{km:519.7},{km:521},{km:521.5},{km:524.3},{km:525.2},{km:527.9},{km:529},{km:531},{km:532.1},{km:533},{km:533.1},{km:536.8},{km:538.2},{km:539.7},{km:543.8},{km:544.6},{km:545.3},{km:546.6},{km:547.6},{km:548.8},{km:550.8},{km:552.4},{km:553},{km:554.8},{km:558},{km:561},{km:561.3},{km:563},{km:563.6},{km:565.5},{km:567},{km:568}]}};

let tramoActual="L6M", actual=null;

/* ================= INIT ================= */
selectorTramo.innerHTML=`<option value="L6M">R√≠o Paran√° ‚Äì L6M</option>`;
horaInicio.value=new Date().toTimeString().slice(0,5);
render();

/* ================= UI ================= */
function render(){
  lista.innerHTML="";
  TRAMOS[tramoActual].data.forEach(e=>{
    const d=document.createElement("div");
    d.className="km";
    d.innerHTML=`<b>KM ${e.km}</b>`;
    d.onclick=()=>seleccionar(e,d);
    lista.appendChild(d);
  });
}

function seleccionar(e,div){
  document.querySelectorAll(".km").forEach(x=>x.classList.remove("selected"));
  actual=e; div.classList.add("selected");
  kmActual.value=e.km;
}

/* ================= OBS ================= */
let unsubscribe=null;

window.verObs = function(){
  kmObs.textContent=actual.km;
  if(unsubscribe) unsubscribe();

  const ref=collection(db,"observaciones",tramoActual,String(actual.km));
  const q=query(ref,orderBy("fecha","desc"));

  unsubscribe=onSnapshot(q,(snap)=>{
    historial.innerHTML="";
    snap.forEach(d=>{
      const o=d.data();
      historial.innerHTML+=`
      <div class="historico">
        <div class="fecha">${o.fecha.toDate().toLocaleString()}</div>
        <div>${o.texto}</div>
        ${esAdmin?`
        <button onclick="editarObs('${d.id}')">‚úèÔ∏è</button>
        <button onclick="borrarObs('${d.id}')">üóë</button>`:""}
      </div>`;
    });
  });

  modalObs.style.display="flex";
}

window.guardarObs = async function(){
  const texto=textoObs.value.trim();
  if(texto.length<5) return;
  await addDoc(collection(db,"observaciones",tramoActual,String(actual.km)),{
    texto,fecha:new Date(),admin:esAdmin
  });
  textoObs.value="";
}

window.editarObs = async function(id){
  const t=prompt("Editar observaci√≥n:");
  if(!t||t.length<5) return;
  await updateDoc(doc(db,"observaciones",tramoActual,String(actual.km),id),{texto:t});
}

window.borrarObs = async function(id){
  if(confirm("¬øBorrar observaci√≥n?"))
    await deleteDoc(doc(db,"observaciones",tramoActual,String(actual.km),id));
}

window.cerrar=id=>document.getElementById(id).style.display="none";
</script>

</body>
</html>
