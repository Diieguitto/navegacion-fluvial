<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Navegaci√≥n Fluvial</title>
<style>
/* --- ESTILOS --- */
body{font-family:Arial;background:#f4f6f8;padding:20px;}
header{position:relative;background:#1e3a5f;color:white;padding:15px;border-radius:6px;margin-bottom:15px;}
#adminBtn{position:absolute;top:12px;right:15px;background:transparent;border:none;font-size:18px;cursor:pointer;}
select,input,button{padding:6px;font-size:14px;}
.km{background:white;padding:8px;margin-bottom:6px;border-left:6px solid #ccc;border-radius:4px;cursor:pointer;}
.km:hover{background:#eef2f7;}
.selected{outline:2px solid #ff9800;}
.roja{border-left-color:#c62828;}
.verde{border-left-color:#2e7d32;}
.negra{border-left-color:#000;}
.azul{border-left-color:#1565c0;}
.violeta{border-left-color:#6a1b9a;}
.obs{font-size:13px;color:#333;margin-top:4px;}
.menu{margin-top:8px;padding-top:8px;border-top:1px dashed #ccc;}
.menu button{margin-right:6px;font-size:13px;}
.panel{background:white;padding:12px;border-radius:6px;margin-bottom:15px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;}
.modal-content{background:white;padding:15px;border-radius:6px;max-width:520px;width:90%;max-height:90%;overflow:auto;}
.close{float:right;font-weight:bold;cursor:pointer;}
textarea{width:100%;min-height:70px;}
.historico{font-size:13px;margin-bottom:8px;border-bottom:1px solid #ddd;padding-bottom:4px;}
.fecha{color:#555;font-size:12px;}
@media(max-width:600px){select,input,button{width:100%;margin:5px 0;font-size:16px;}}
</style>
</head>

<body>
<header>
    <button id="adminBtn">üîí</button>
    <h2 id="tituloTramo"></h2>
    Tramo:
    <select id="selectorTramo"></select>
    Sentido:
    <select id="sentido">
        <option value="up">Aguas arriba</option>
        <option value="down">Aguas abajo</option>
    </select>
</header>

<div class="panel">
<h3>üìè Estimativas</h3>
KM actual: <input id="kmActual" type="number" step="0.1">
Velocidad (km/h): <input id="velocidad" type="number" value="12" step="0.1">
Hora inicio: <input id="horaInicio" type="time">
<div id="resultado"></div>
</div>

<div id="lista"></div>

<!-- MODAL CARTA -->
<div class="modal" id="modalCarta">
<div class="modal-content">
<span class="close" onclick="cerrar('modalCarta')">√ó</span>
<h3>Carta n√°utica</h3>
<img id="imgCarta" style="width:100%">
</div>
</div>

<!-- MODAL OBS -->
<div class="modal" id="modalObs">
<div class="modal-content">
<span class="close" onclick="cerrar('modalObs')">√ó</span>
<h3>Observaciones ‚Äì KM <span id="kmObs"></span></h3>
<div id="historial"></div>
<textarea id="textoObs"></textarea>
<button id="btnGuardarObs">Guardar</button>
</div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyCdffoO-Bmp0EY2Lu-HxNga0hTRHr3S9BA",
  authDomain: "navegacion-fluvial.firebaseapp.com",
  databaseURL: "https://navegacion-fluvial-default-rtdb.firebaseio.com",
  projectId: "navegacion-fluvial",
  storageBucket: "navegacion-fluvial.appspot.com",
  messagingSenderId: "767971648775",
  appId: "1:767971648775:web:784d1ac3310653e7d891a2",
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- VARIABLES DOM ---
const adminBtn = document.getElementById("adminBtn");
const tituloTramo = document.getElementById("tituloTramo");
const selectorTramo = document.getElementById("selectorTramo");
const sentido = document.getElementById("sentido");
const lista = document.getElementById("lista");
const kmActual = document.getElementById("kmActual");
const velocidad = document.getElementById("velocidad");
const horaInicio = document.getElementById("horaInicio");
const resultado = document.getElementById("resultado");
const modalCarta = document.getElementById("modalCarta");
const imgCarta = document.getElementById("imgCarta");
const modalObs = document.getElementById("modalObs");
const kmObs = document.getElementById("kmObs");
const historial = document.getElementById("historial");
const textoObs = document.getElementById("textoObs");
const btnGuardarObs = document.getElementById("btnGuardarObs");

// --- ADMIN ---
const CLAVE_ADMIN = "parana123";
let esAdmin = localStorage.getItem("admin")==="true";
function actualizarIconoAdmin(){ adminBtn.textContent = esAdmin?"üîì":"üîí"; }
function activarAdmin(){
    if(esAdmin){ if(confirm("Salir del modo administrador?")){ esAdmin=false; localStorage.removeItem("admin"); actualizarIconoAdmin(); } }
    else{ const pass=prompt("Clave administrador:"); if(pass===CLAVE_ADMIN){ esAdmin=true; localStorage.setItem("admin","true"); actualizarIconoAdmin(); } else alert("Clave incorrecta"); }
}
adminBtn.onclick = activarAdmin;

// --- TRAMOS ---
const TRAMOS = {
    L6M:{ nombre:"R√≠o Paran√° ‚Äì Tramo KM 480 a 568 (L6M)", inicio:480, fin:568, destinos:[533,568], data:[
        { km:480, clase:"violeta", txt:"Inicio L6M" },
        { km:481.4, clase:"roja" },
        { km:484.5, clase:"roja", obs:"Se puede cruzar mano con mano" },
        { km:486, clase:"negra", txt:"Peligro aislado" },
        { km:499.7, clase:"verde" },
        { km:533, clase:"azul", txt:"Puerto Diamante" },
        { km:568, clase:"violeta", txt:"Fin L6M" }
    ]},
    L6N:{ nombre:"R√≠o Paran√° ‚Äì Tramo KM 568 a 677 (L6N)", inicio:568, fin:677, destinos:[600,677], data:[
        { km:568, clase:"violeta", txt:"Inicio L6N" },
        { km:572, clase:"roja", obs:"Curva peligrosa" },
        { km:580, clase:"verde" },
        { km:590, clase:"negra", txt:"Peligro aislado" },
        { km:610, clase:"verde" },
        { km:630, clase:"roja" },
        { km:650, clase:"verde" },
        { km:677, clase:"violeta", txt:"Fin L6N" }
    ]}
};

let tramoActual="L6M", actual=null;

function horaSistema(){ const d=new Date(); return d.toTimeString().slice(0,5); }

function inicializarTramos(){
    selectorTramo.innerHTML="";
    for(const key in TRAMOS){
        const opt=document.createElement("option");
        opt.value=key; opt.textContent=TRAMOS[key].nombre;
        selectorTramo.appendChild(opt);
    }
    selectorTramo.value=tramoActual;
}

selectorTramo.onchange = ()=>{ tramoActual=selectorTramo.value; sentido.value="up"; cambiarSentido(); }
sentido.onchange = cambiarSentido;

function cambiarSentido(){
    const t=TRAMOS[tramoActual];
    kmActual.value = sentido.value==="up"?t.inicio:t.fin;
    horaInicio.value = horaSistema();
    render(); recalcular();
}

function render(){
    const t=TRAMOS[tramoActual];
    tituloTramo.textContent=t.nombre;
    lista.innerHTML="";
    let arr=[...t.data]; if(sentido.value==="down") arr.reverse();
    arr.forEach(e=>{
        const d=document.createElement("div");
        d.className="km "+(e.clase||"");
        d.innerHTML=`<b>KM ${e.km}</b>`;
        if(e.txt)d.innerHTML+=`<div class="obs">${e.txt}</div>`;
        if(e.obs)d.innerHTML+=`<div class="obs">${e.obs}</div>`;
        d.onclick=()=>seleccionar(e,d);
        lista.appendChild(d);
    });
}

function seleccionar(e,div){
    document.querySelectorAll(".km").forEach(x=>{ x.classList.remove("selected"); x.querySelector(".menu")?.remove(); });
    actual=e; div.classList.add("selected"); kmActual.value=e.km;
    if(!horaInicio.value) horaInicio.value=horaSistema();
    const m=document.createElement("div"); m.className="menu";
    m.innerHTML=`<button onclick="verCarta()">üó∫ Carta</button><button onclick="verObs()">üìù Obs</button>`;
    div.appendChild(m); recalcular();
}

function recalcular(){
    if(!horaInicio.value) return;
    const km=+kmActual.value, vel=+velocidad.value; if(!vel) return;
    const [h,m]=horaInicio.value.split(":").map(Number);
    const inicio=h*60+m;
    const t=TRAMOS[tramoActual];
    let out="<b>ETA:</b><br>";
    t.destinos.forEach(d=>{
        const tt=inicio+Math.abs(d-km)/vel*60;
        const hh=Math.floor(tt/60)%24;
        const mm=Math.floor(tt%60);
        out+=`KM ${d}: ${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}<br>`;
    });
    resultado.innerHTML=out;
}

// --- OBSERVACIONES FIREBASE ---
function verObs(){
    kmObs.textContent=actual.km;
    cargarHistorial();
    modalObs.style.display="flex";
}

function cargarHistorial(){
    historial.innerHTML="";
    const obsRef = ref(db, `obs/${tramoActual}/${actual.km}`);
    onValue(obsRef, snapshot=>{
        const data = snapshot.val();
        historial.innerHTML="";
        if(data){
            Object.values(data).forEach(o=>{
                historial.innerHTML += `<div class="historico"><div class="fecha">${new Date(o.fecha).toLocaleString()}</div><div>${o.texto}</div></div>`;
            });
        }
    });
}

btnGuardarObs.onclick=()=>{
    const texto = textoObs.value.trim();
    if(texto.length<5){ alert("M√≠nimo 5 caracteres"); return; }
    const obsRef = ref(db, `obs/${tramoActual}/${actual.km}`);
    push(obsRef, { texto, fecha: new Date().toISOString() });
    textoObs.value="";
};

// --- CARTAS ---
function verCarta(){
    let kmStr = Number.isInteger(actual.km)?String(actual.km):String(actual.km).replace('.', '_');
    imgCarta.src=`https://Diieguitto.github.io/navegacion-fluvial/cartas/${kmStr}.jpg`;
    imgCarta.onerror=()=>{ imgCarta.src="https://Diieguitto.github.io/navegacion-fluvial/cartas/placeholder.jpg"; };
    modalCarta.style.display="flex";
}

// --- UTIL ---
function cerrar(id){ document.getElementById(id).style.display="none"; }

// --- INIT ---
inicializarTramos();
cambiarTramo();
</script>
</body>
</html>
