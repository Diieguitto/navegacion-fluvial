<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Navegaci√≥n Fluvial</title>
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px;}
header{
    position:relative;
    background:#1e3a5f;color:white;
    padding:15px;
    border-radius:6px;
    margin-bottom:15px;
}
#adminBtn{position:absolute;top:12px;right:15px;background:transparent;border:none;font-size:18px;cursor:pointer;}
select,input,button{padding:6px;font-size:14px;}
.km{background:white;padding:8px;margin-bottom:6px;border-left:6px solid #ccc;border-radius:4px;cursor:pointer;}
.km:hover{background:#eef2f7;}
.selected{outline:2px solid #ff9800;}
.roja{border-left-color:#c62828;}
.verde{border-left-color:#2e7d32;}
.negra{border-left-color:#000;}
.azul{border-left-color:#1565c0;}
.violeta{border-left-color:#6a1b9a;}
.obs{font-size:13px;color:#333;margin-top:4px;}
.menu{margin-top:8px;padding-top:8px;border-top:1px dashed #ccc;}
.menu button{margin-right:6px;font-size:13px;}
.panel{background:white;padding:12px;border-radius:6px;margin-bottom:15px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;}
.modal-content{background:white;padding:15px;border-radius:6px;max-width:520px;width:90%;max-height:90%;overflow:auto;}
.close{float:right;font-weight:bold;cursor:pointer;}
textarea{width:100%;min-height:70px;}
.historico{font-size:13px;margin-bottom:8px;border-bottom:1px solid #ddd;padding-bottom:4px;}
.fecha{color:#555;font-size:12px;}
.prohibicion { background: rgba(198, 40, 40, 0.12);}
@media(max-width:600px){select,input,button{width:100%;margin:5px 0;font-size:16px;}}
</style>
</head>

<body>
<header>
    <button id="adminBtn" onclick="activarAdmin()">üîí</button>
    <h2 id="tituloTramo"></h2>
    <div id="alertaTramo"></div>
    <button onclick="nuevaAlerta()" style="margin-left:10px;background:#c62828;color:white;padding:6px;border:none;border-radius:4px;cursor:pointer;">
        ‚ö†Ô∏è Reportar alerta
    </button>

    Tramo:
    <select id="selectorTramo" onchange="cambiarTramo()"></select>

    Sentido:
    <select id="sentido" onchange="cambiarSentido()">
        <option value="up">Aguas arriba</option>
        <option value="down">Aguas abajo</option>
    </select>
</header>

<div class="panel">
<h3>üìè Estimativas</h3>
KM actual:
<input id="kmActual" type="number" step="0.1" oninput="kmManual=true; recalcular()">

Velocidad (km/h):
<input id="velocidad" type="number" value="12" step="0.1" oninput="recalcular()">

KM destino (opcional):
<input id="kmDestinoManual" type="number" step="0.1" oninput="recalcular()">

Hora inicio:
<input id="horaInicio" type="time" oninput="recalcular()">

<div id="resultado"></div>
</div>

<div id="lista"></div>

<!-- MODAL CARTA -->
<div class="modal" id="modalCarta">
<div class="modal-content">
<span class="close" onclick="cerrar('modalCarta')">√ó</span>
<h3>Carta n√°utica</h3>
<img id="imgCarta" style="width:100%">
<div id="adminCarta"></div>
</div>
</div>

<!-- MODAL OBS -->
<div class="modal" id="modalObs">
<div class="modal-content">
<span class="close" onclick="cerrar('modalObs')">√ó</span>
<h3>Observaciones ‚Äì KM <span id="kmObs"></span></h3>
<div id="historial"></div>
<textarea id="textoObs"></textarea>
<button onclick="guardarObs()">Guardar</button>
</div>
</div>

<!-- MODAL ALERTA -->
<div class="modal" id="modalAlerta">
    <div class="modal-content">
      <span class="close" onclick="cerrar('modalAlerta')">√ó</span>
      <h3>üì¢ Reportar prohibici√≥n o alerta</h3>
      <label>Desde KM:</label>
      <input type="number" id="alertaDesde" step="0.1"><br>
      <label>Hasta KM (opcional):</label>
      <input type="number" id="alertaHasta" step="0.1"><br>
      <label>Descripci√≥n:</label>
      <textarea id="alertaTexto"></textarea><br>
      <button onclick="guardarAlerta()">Guardar alerta</button>
    </div>
</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot,
  deleteDoc,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCdffoO-Bmp0EY2Lu-HxNga0hTRHr3S9BA",
  authDomain: "navegacion-fluvial.firebaseapp.com",
  projectId: "navegacion-fluvial",
  storageBucket: "navegacion-fluvial.firebasestorage.app",
  messagingSenderId: "767971648775",
  appId: "1:767971648775:web:784d1ac3310653e7d891a2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= ELEMENTOS GLOBALES ================= */
const tituloTramo = document.getElementById("tituloTramo");
const lista = document.getElementById("lista");
const modalCarta = document.getElementById("modalCarta");
const imgCarta = document.getElementById("imgCarta");
const adminBtn = document.getElementById("adminBtn");
const kmActual = document.getElementById("kmActual");
const sentido = document.getElementById("sentido");
const horaInicio = document.getElementById("horaInicio");
const resultado = document.getElementById("resultado");

/* ================= VARIABLES ================= */
let tramoActual="L6M";
let actual=null;
let kmManual = false;
let alertasUsuario = [];
let esAdmin = localStorage.getItem("admin")==="true";

/* ================= TRAMOS ================= */
const TRAMOS = {
    L6M: {
        nombre: "R√≠o Paran√° ‚Äì Tramo KM 480 a 568 (L6M)",
        inicio: 480,
        fin: 568,
        destinos: [533,568],
        zonasFijas: [
            { tipo: "prohibicion_cruce", desde: 492, hasta: 498, texto: "Canal angosto ‚Äì prohibido cruce" },
            { tipo: "prohibicion_cruce", desde: 505, hasta: 507, texto: "Vuelta cerrada ‚Äì prohibido cruce" }
        ],
        data: [
            {km:480,tipo:"sistema",clase:"violeta",txt:"Isla El Zambo MD ‚Äì Fin L6I / Inicio L6M"},
            {km:481.4,tipo:"boya",clase:"roja"},
            {km:484.5,tipo:"boya",clase:"roja",obs:"Se puede cruzar mano con mano"},
            {km:486,tipo:"peligro",clase:"negra",txt:"Imperial 339 MI ‚Äì Peligro aislado"},
            {km:488,tipo:"obs",txt:"0,80 ‚Äì mala v√≠a ‚Äì 40 ft"},
            {km:489.4,tipo:"boya",clase:"verde"},
            {km:491,tipo:"boya",clase:"roja"},
            {km:492,tipo:"boya",clase:"roja"},
            {km:494,tipo:"boya",clase:"roja",obs:"0,80 a mala v√≠a ‚Äì 23 ft"},
            {km:495.8,tipo:"boya",clase:"roja"},
            {km:497.5,tipo:"boya",clase:"roja"},
            {km:498,tipo:"zona",txt:"Zona de espera"},
            {km:499.7,tipo:"boya",clase:"verde"},
            {km:500,tipo:"obs",txt:"Vuelta del 500"},
            {km:500.5,tipo:"boya",clase:"roja"},
            {km:501.6,tipo:"boya",clase:"verde"},
            {km:502.4,tipo:"boya",clase:"roja"},
            {km:504.5,tipo:"boya",clase:"verde"},
            {km:506.7,tipo:"boya",clase:"verde"},
            {km:508,tipo:"boya",clase:"roja"},
            {km:509.2,tipo:"boya",clase:"roja"},
            {km:509.9,tipo:"boya",clase:"verde"},
            {km:513.7,tipo:"boya",clase:"verde"},
            {km:516.2,tipo:"boya",clase:"verde"},
            {km:517.9,tipo:"boya",clase:"verde"},
            {km:518.4,tipo:"boya",clase:"verde",obs:"A mala v√≠a"},
            {km:519.7,tipo:"boya",clase:"roja"},
            {km:521,tipo:"peligro",clase:"negra",txt:"Peligro aislado"},
            {km:521.5,tipo:"boya",clase:"roja"},
            {km:524.3,tipo:"boya",clase:"roja"},
            {km:525.2,tipo:"boya",clase:"roja"},
            {km:527.9,tipo:"boya",clase:"verde"},
            {km:529,tipo:"boya",clase:"verde"},
            {km:531,tipo:"boya",clase:"roja"},
            {km:532.1,tipo:"boya",clase:"roja"},
            {km:533,tipo:"ciudad",clase:"azul",txt:"Puerto Diamante ‚Äì Informar L6M"},
            {km:533.1,tipo:"boya",clase:"roja"},
            {km:536.8,tipo:"boya",clase:"roja"},
            {km:538.2,tipo:"boya",clase:"verde"},
            {km:539.7,tipo:"boya",clase:"verde"},
            {km:543.8,tipo:"boya",clase:"verde"},
            {km:544.6,tipo:"boya",clase:"verde"},
            {km:545.3,tipo:"boya",clase:"verde",obs:"ATENCI√ìN"},
            {km:546.6,tipo:"boya",clase:"verde"},
            {km:547.6,tipo:"boya",clase:"verde"},
            {km:548.8,tipo:"boya",clase:"roja"},
            {km:550.8,tipo:"boya",clase:"roja"},
            {km:552.4,tipo:"boya",clase:"roja"},
            {km:553,tipo:"boya",clase:"roja",txt:"Gral. Alvear"},
            {km:554.8,tipo:"boya",clase:"roja"},
            {km:558,tipo:"boya",clase:"verde"},
            {km:561,tipo:"zona",txt:"√öltima zona de espera"},
            {km:561.3,tipo:"boya",clase:"roja"},
            {km:563,tipo:"obs",txt:"Corre mucho"},
            {km:563.6,tipo:"boya",clase:"verde"},
            {km:565.5,tipo:"boya",clase:"roja"},
            {km:567,tipo:"boya",clase:"roja",txt:"Bifurcaci√≥n ‚Äì espera"},
            {km:568,tipo:"sistema",clase:"violeta",txt:"Fin L6M ‚Äì Inicio L6N"}
        ]
    },
    L6N: {
        nombre: "R√≠o Paran√° ‚Äì Tramo KM 568 a 677 (L6N)",
        inicio: 568,
        fin: 677,
        destinos: [600,677],
        data: [
            { km: 568, clase: "violeta", txt: "Inicio L6N" },
            { km: 572, clase: "roja", obs: "Curva peligrosa" },
            { km: 580, clase: "verde" },
            { km: 590, clase: "negra", txt: "Peligro aislado" },
            { km: 610, clase: "verde" },
            { km: 630, clase: "roja" },
            { km: 650, clase: "verde" },
            { km: 677, clase: "violeta", txt: "Fin L6N" }
        ]
    }
};

/* ================= FUNCIONES ================= */
function horaSistema(){ const d=new Date(); return d.toTimeString().slice(0,5); }

function inicializarTramos(){
    const selector = document.getElementById("selectorTramo");
    selector.innerHTML = "";
    for(const key in TRAMOS){
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = TRAMOS[key].nombre;
        selector.appendChild(opt);
    }
    selector.value = tramoActual;
}

function cambiarTramo(){
    tramoActual = document.getElementById("selectorTramo").value;
    kmManual = false;
    sentido.value = "up";
    cambiarSentido();
}
window.cambiarTramo = cambiarTramo;

function cambiarSentido(){
    const t = TRAMOS[tramoActual];
    if(!kmManual) kmActual.value = sentido.value==="up"?t.inicio:t.fin;
    if(!horaInicio.value) horaInicio.value = horaSistema();
    render(); recalcular(); mostrarAlertaTramo(); escucharAlertasUsuario(); actualizarIconoAdmin();
    inicializarTramos();
    cargarAlertasUsuario();
}
window.cambiarSentido = cambiarSentido;

function actualizarIconoAdmin(){ adminBtn.textContent = esAdmin?"üîì":"üîí"; }

function zonasCruceActivas(km){
    const t=TRAMOS[tramoActual];
    let fijas = t.zonasFijas ? t.zonasFijas.filter(z=>z.tipo==="prohibicion_cruce") : [];
    let usuario = alertasUsuario.filter(a=>a.tipo==="prohibicion_cruce" && km>=a.desde && km<=a.hasta);
    return [...fijas, ...usuario];
}

function mostrarAlertaTramo(){
    const cont = document.getElementById("alertaTramo");
    const t = TRAMOS[tramoActual];
    let zonas = [];
    if(t.zonasFijas) zonas.push(...t.zonasFijas.filter(z=>z.tipo==="prohibicion_cruce"));
    zonas.push(...alertasUsuario.map(a=>({desde:a.desde,hasta:a.hasta,texto:a.texto})));
    if(!zonas.length){ cont.innerHTML=""; return; }
    zonas.sort((a,b)=>sentido.value==="up"?a.desde-b.desde:b.desde-a.desde);
    cont.innerHTML=`
    <div style="background:#fff3cd;color:#333;padding:8px 10px;border-left:6px solid #c62828;border-radius:5px;margin-top:8px;font-size:12.5px;line-height:1.4;">
        ‚õî <b>Prohibiciones y alertas en el tramo</b><br>
        ${zonas.map(z=>{
            const d1 = sentido.value==="up"?z.desde:z.hasta;
            const d2 = sentido.value==="up"?z.hasta:z.desde;
            return `‚Ä¢ KM ${d1} a ${d2} ‚Äì ${z.texto}`;
        }).join("<br>")}
    </div>
    `;
}

/* ================= ALERTAS DE USUARIO ================= */
window.nuevaAlerta = function(){
    if(esAdmin){ alert("El administrador no puede reportar alertas de usuario."); return; }
    document.getElementById("alertaDesde").value="";
    document.getElementById("alertaHasta").value="";
    document.getElementById("alertaTexto").value="";
    document.getElementById("modalAlerta").style.display="flex";
}

window.guardarAlerta = async function(){
    const desde=parseFloat(document.getElementById("alertaDesde").value);
    let hasta=parseFloat(document.getElementById("alertaHasta").value);
    const texto=document.getElementById("alertaTexto").value.trim();
    if(isNaN(desde)||texto.length<5){ alert("KM inicial y descripci√≥n son obligatorios."); return; }
    if(isNaN(hasta)||hasta<desde) hasta=desde;
    const ref = collection(db,"alertas_usuario",tramoActual);
    await addDoc(ref,{desde,hasta,texto,fecha:new Date(),admin:false});
    cerrar("modalAlerta");
}

async function cargarAlertasUsuario(){
    const ref = collection(db,"alertas_usuario",tramoActual);
    const q = query(ref,orderBy("fecha","desc"));
    onSnapshot(q,snap=>{
        alertasUsuario = snap.docs.map(d=>({id:d.id,...d.data()}));
        render(); mostrarAlertaTramo();
    });
}

function render(){
    if(!TRAMOS[tramoActual]) return;
    tituloTramo.textContent = TRAMOS[tramoActual].nombre;
    lista.innerHTML="";
    let arr=[...TRAMOS[tramoActual].data];
    if(sentido.value==="down") arr.reverse();
    arr.forEach(e=>{
        const d=document.createElement("div");
        d.className="km "+(e.clase||"");
        const crucesKm=zonasCruceActivas(e.km);
        if(crucesKm.length) d.classList.add("prohibicion");
        d.innerHTML=`<b>KM ${e.km}</b>`;
        if(e.txt) d.innerHTML+=`<div class="obs">${e.txt}</div>`;
        if(e.obs) d.innerHTML+=`<div class="obs">${e.obs}</div>`;
        const alertasKm=alertasUsuario.filter(a=>e.km>=a.desde && e.km<=a.hasta);
        if(alertasKm.length){
            const aviso=document.createElement("div");
            aviso.className="obs";
            aviso.innerHTML=alertasKm.map(a=>`‚ö†Ô∏è ${a.texto}`).join("<br>");
            if(esAdmin){
                alertasKm.forEach(alerta=>{
                    const btnBorrar=document.createElement("button");
                    btnBorrar.textContent="üóë";
                    btnBorrar.style.marginLeft="5px";
                    btnBorrar.onclick=async()=>{await deleteDoc(doc(db,"alertas_usuario",tramoActual,alerta.id))};
                    aviso.appendChild(btnBorrar);
                });
            }
            d.appendChild(aviso);
        }
        d.onclick=()=>seleccionar(e,d);
        lista.appendChild(d);
    });
}

function seleccionar(e,div){
    if(!e) return;
    document.querySelectorAll(".km").forEach(x=>{x.classList.remove("selected"); x.querySelector(".menu")?.remove();});
    actual=e; kmActual.value=e.km; kmManual=false; if(!horaInicio.value) horaInicio.value=horaSistema();
    const crucesKm=zonasCruceActivas(e.km);
    if(crucesKm.length){
        const aviso=document.createElement("div");
        aviso.className="obs";
        aviso.innerHTML=crucesKm.map(z=>`‚õî ${z.texto} (${z.desde}‚Äì${z.hasta})`).join("<br>");
        div.appendChild(aviso);
    }
    const m=document.createElement("div");
    m.className="menu";
    m.innerHTML=`<button onclick="verCarta()">üó∫ Carta</button><button onclick="verObs()">üìù Obs</button>`;
    div.appendChild(m);
    div.classList.add("selected");
    recalcular();
}

function recalcular(){
    if(!horaInicio.value) return;
    const km=+kmActual.value, vel=+velocidad.value;
    if(!vel) return;
    const destinoManualInput=document.getElementById("kmDestinoManual");
    const destinoManual=destinoManualInput.value?+destinoManualInput.value:null;
    const [h,m]=horaInicio.value.split(":").map(Number), inicio=h*60+m;
    const t=TRAMOS[tramoActual];
    let out="<b>ETA:</b><br>";
    zonasCruceActivas(km).forEach(z=>{
        out+=`<div style="background:#c62828;color:white;padding:6px;border-radius:4px;margin-bottom:6px;font-weight:bold;">
        ‚õî PROHIBIDO CRUCE<br>${z.texto}<br>KM ${z.desde} ‚Üí KM ${z.hasta}</div>`;
    });
    t.destinos.forEach(d=>{
        const minutosViaje=Math.abs(d-km)/vel*60;
        const tt=inicio+minutosViaje;
        const hh=Math.floor(tt/60)%24, mm=Math.floor(tt%60);
        out+=`KM ${d}: ${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}<span style="color:#555"> (+ ${formatearDuracion(minutosViaje)})</span><br>`;
    });
    if(destinoManual!==null&&!isNaN(destinoManual)){
        const minutosViaje=Math.abs(destinoManual-km)/vel*60;
        const tt=inicio+minutosViaje;
        const hh=Math.floor(tt/60)%24, mm=Math.floor(tt%60);
        out+=`<hr><b>KM ${destinoManual}:</b> ${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}<span style="color:#555"> (+ ${formatearDuracion(minutosViaje)})</span>`;
    }
    resultado.innerHTML=out;
}
window.recalcular=recalcular;

function formatearDuracion(minutos){ const h=Math.floor(minutos/60), m=Math.round(minutos%60); return `${h} h ${m} min`; }

window.cerrar=function(id){document.getElementById(id).style.display="none";}

/* ================= ADMIN ================= */
const CLAVE_ADMIN="parana123";
window.activarAdmin=function(){
    if(esAdmin){
        if(confirm("¬øSalir del modo administrador?")){ esAdmin=false; localStorage.removeItem("admin"); }
    } else {
        const pass=prompt("Clave administrador:");
        if(pass===CLAVE_ADMIN){ esAdmin=true; localStorage.setItem("admin","true"); }
        else alert("Clave incorrecta");
    }
    actualizarIconoAdmin();
}

/* ================= OBSERVACIONES ================= */
let unsubscribeObs=null;
function escucharObservaciones(){
    if(!actual) return;
    if(unsubscribeObs) unsubscribeObs();
    const ref=collection(db,"observaciones",tramoActual,String(actual.km));
    const q=query(ref,orderBy("fecha","desc"));
    unsubscribeObs=onSnapshot(q,snap=>{
        const historial=document.getElementById("historial");
        historial.innerHTML="";
        snap.forEach(docu=>{
            const o=docu.data();
            const div=document.createElement("div");
            div.className="historico";
            div.innerHTML=`<div class="fecha">${o.fecha.toDate().toLocaleString()}</div><div>${o.texto}</div>${esAdmin?`<button onclick="editarObs('${docu.id}')">‚úèÔ∏è</button><button onclick="borrarObs('${docu.id}')">üóë</button>`:""}`;
            historial.appendChild(div);
        });
    });
}

window.verObs=function(){
    if(!actual) { alert("Selecciona un KM primero"); return; }
    document.getElementById("kmObs").textContent=actual.km;
    document.getElementById("modalObs").style.display="flex";
    escucharObservaciones();
}

window.guardarObs=async function(){
    if(!actual) return;
    const textarea=document.getElementById("textoObs");
    const texto=textarea.value.trim();
    if(texto.length<5){ alert("La observaci√≥n debe tener al menos 5 caracteres."); return; }
    const ref=collection(db,"observaciones",tramoActual,String(actual.km));
    await addDoc(ref,{texto,fecha:new Date(),admin:esAdmin});
    textarea.value="";
}

window.editarObs=async function(id){
    if(!esAdmin||!actual) return;
    const nuevo=prompt("Editar observaci√≥n:");
    if(!nuevo||nuevo.trim().length<5) return;
    const ref=doc(db,"observaciones",tramoActual,String(actual.km),id);
    await updateDoc(ref,{texto:nuevo.trim()});
}

window.borrarObs=async function(id){
    if(!confirm("¬øBorrar observaci√≥n?")) return;
    if(!actual) return;
    const ref=doc(db,"observaciones",tramoActual,String(actual.km),id);
    await deleteDoc(ref);
}

/* ================= CARTAS ================= */
window.verCarta=function(){
    if(!actual) return;
    let kmStr=Number.isInteger(actual.km)?String(actual.km):String(actual.km).replace(".", "_");
    imgCarta.src=`https://Diieguitto.github.io/navegacion-fluvial/CARTAS/${kmStr}.jpg`;
    imgCarta.onerror=()=>{ imgCarta.src="https://Diieguitto.github.io/navegacion-fluvial/CARTAS/placeholder.jpg"; };
    modalCarta.style.display="flex";
}

/* ================= INIT ================= */
actualizarIconoAdmin();
inicializarTramos();
horaInicio.value=horaSistema();
cambiarTramo();
</script>
</body>
</html>
